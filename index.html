<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayleys Property Survey System</title>
    
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ2hpei1jIiwiYSI6ImNtbHpsczQwMTA4bGszZnEyOWk3ejdsdzQifQ.Uyr2i4jlcL04Rf8aaEzv-A';
    </script>
    
    <style>
        /* BASE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height: 100vh; width: 100vw; overflow: hidden; background: #1a1a2e; color: #1a202c; -webkit-font-smoothing: antialiased; }

        /* DEBUG CONSOLE */
        #debugConsole {
            position: fixed; bottom: 20px; left: 20px; width: 300px;
            background: rgba(15, 23, 42, 0.95); color: #10b981; font-family: monospace; font-size: 11px;
            padding: 12px 16px; border-radius: 8px; z-index: 9999; pointer-events: none;
            border-left: 4px solid #10b981; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: opacity 0.5s ease, transform 0.5s ease; 
            opacity: 0; transform: translateY(10px);
        }
        #debugConsole.error { color: #ef4444; border-left-color: #ef4444; }

        /* SCREENS */
        .screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .screen.active { display: flex; z-index: 10; }

        /* LOGIN */
        #loginScreen { background: #1a1a2e; }
        #loginScreen.active { display: block; }
        #loginMapBackground { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; opacity: 0.6; width: 100%; height: 100%; }
        
        .login-card {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: white; border-radius: 12px; padding: 40px; width: 380px; text-align: center;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5); z-index: 10;
        }
        .login-header h1 { font-size: 28px; font-weight: 700; color: #00264b; margin-bottom: 5px; }
        .login-header p { font-size: 13px; color: #64748b; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 6px; letter-spacing: 0.2px; }
        .form-input { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; transition: 0.2s; color: #0f172a; }
        .form-input:focus { outline: none; border-color: #00264b; background: #fff; box-shadow: 0 4px 12px rgba(0,38,75,0.08); }
        .btn-access { width: 100%; padding: 14px; background: #00264b; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-access:hover { background: #001d3a; transform: translateY(-1px); box-shadow: 0 6px 15px rgba(0,38,75,0.2); }

        /* DASHBOARD LAYOUT */
        .sidebar { width: 380px; background: white; display: flex; flex-direction: column; z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.1); height: 100vh; }
        .main-content { flex: 1; position: relative; height: 100vh; background: #e2e8f0; }
        
        /* SIDEBAR HEADER */
        .sidebar-header { padding: 0; background: #00264b; color: white; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        .sidebar-logo-container { background: #fff; width: 100%; height: 110px; padding: 0; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .sidebar-logo-container img { width: 100%; height: 100%; display: block; object-fit: cover; object-position: center; }
        .sidebar-header p { margin: 0; padding: 14px 0; opacity: 0.9; font-size: 10px; letter-spacing: 2px; font-weight: 600; text-transform: uppercase; }
        
        .user-profile { padding: 18px 24px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 36px; height: 36px; background: #00264b; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; box-shadow: 0 2px 8px rgba(0,38,75,0.2); }
        .logout-link { font-size: 10px; color: #ef4444; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; }
        .logout-link:hover { color: #dc2626; }

        /* CUSTOM SIDEBAR SEARCH */
        .sidebar-search-container { padding: 16px 24px; background: #fff; border-bottom: 1px solid #e2e8f0; }
        .search-input-wrapper { display: flex; align-items: center; background: #f1f5f9; border: 1px solid transparent; border-radius: 10px; padding: 0 14px; height: 44px; position: relative; transition: 0.2s; }
        .search-input-wrapper:focus-within { border-color: #00264b; background: #fff; box-shadow: 0 4px 15px rgba(0,38,75,0.06); }
        .search-input-wrapper input { flex: 1; border: none; background: transparent; padding: 0 12px; font-size: 14px; color: #1e293b; outline: none; width: 100%; }
        .search-input-wrapper input::placeholder { color: #94a3b8; font-weight: 400; }
        .search-input-wrapper .clear-btn { background: #e2e8f0; border: none; color: #64748b; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .search-input-wrapper .clear-btn:hover { background: #cbd5e1; color: #0f172a; }
        
        /* ADMIN DASHBOARD WIDGETS */
        .admin-dashboard-widgets { 
            position: absolute; top: 24px; right: 24px; left: auto;
            background: rgba(255, 255, 255, 0.45); 
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.15); 
            z-index: 10; border: 1px solid rgba(255,255,255,0.7); 
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex; flex-direction: column; width: 340px;
            overflow: hidden;
        }
        .admin-dashboard-widgets.hidden { opacity: 0; pointer-events: none; transform: translateY(-15px); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px 20px 10px 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.9); padding: 18px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.9); box-shadow: 0 4px 12px rgba(0,0,0,0.03); text-align: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,38,75,0.08); }
        .stat-value { font-size: 26px; font-weight: 700; color: #00264b; margin-bottom: 4px; line-height: 1; letter-spacing: -0.5px; }
        .stat-label { font-size: 10px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;}
        .chart-container { padding: 10px 20px 20px 20px; }
        .chart-box { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; height: 190px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }

        /* FILTER BAR */
        .filter-bar { display: flex; padding: 14px 24px; border-bottom: 1px solid #e2e8f0; gap: 10px; background: #f8fafc; overflow-x: auto; }
        .filter-btn { background: white; border: 1px solid #cbd5e1; padding: 8px 18px; border-radius: 20px; font-size: 12px; font-weight: 500; color: #64748b; cursor: pointer; transition: 0.2s; white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .filter-btn.active { background: #00264b; color: white; border-color: #00264b; box-shadow: 0 4px 12px rgba(0,38,75,0.25); font-weight: 600; }
        
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 20px 24px; background: #fff; }
        
        /* CARD ITEMS */
        .card-item { background: white; border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; margin-bottom: 16px; cursor: pointer; transition: 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .card-item:hover { border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,38,75,0.08); }
        
        .client-card { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 28px 20px; }
        .client-card img { height: 55px; width: auto; max-width: 240px; object-fit: contain; margin-bottom: 18px; }
        .client-card-title { font-weight: 600; font-size: 16px; color: #0f172a; margin-bottom: 8px; }
        .client-card-meta { font-size: 12px; color: #64748b; font-weight: 500; background: #f8fafc; padding: 6px 16px; border-radius: 20px; border: 1px solid #e2e8f0; display: inline-block; }
        .client-card-meta span { color: #00264b; font-weight: 600; }

        .premise-card-image { height: 150px; background: #cbd5e1; border-radius: 8px; margin-bottom: 14px; overflow: hidden; position: relative; }
        .premise-card-image img { width: 100%; height: 100%; object-fit: cover; }
        
        /* STATUS PILLS */
        .status-pill, select.status-select { padding: 5px 14px; border-radius: 20px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; background: white; border: 1px solid transparent; white-space: nowrap; }
        .premise-card-image .status-pill { position: absolute; top: 10px; right: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.25); }
        .reports-table .status-pill, .reports-table .status-select { position: relative; display: inline-block; }
        .status-pill { pointer-events: none; }
        select.status-select { appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; padding-right: 16px; outline: none; transition: all 0.2s ease; background-repeat: no-repeat; background-position: right 8px center; background-size: 10px auto; }
        select.status-select:hover { filter: brightness(0.95); }
        
        .complete-status, .status-pill.complete, .status-select.complete { border-color: #10b981; background: #ecfdf5; color: #047857; }
        .invoice-status, .status-pill.invoice, .status-select.invoice { border-color: #f43f5e; background: #fff1f2; color: #be123c; }
        .pending-status, .status-pill.pending, .status-select.pending { border-color: #8b5cf6; background: #fdf4ff; color: #be185d; }
        .inspection-status, .status-pill.inspection, .status-select.inspection { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
        .new-status, .status-pill.new, .status-select.new { border-color: #0ea5e9; background: #f0f9ff; color: #0369a1; }
        .report-status, .status-pill.report, .status-select.report { border-color: #6366f1; background: #eef2ff; color: #4338ca; }
        .advice-status, .status-pill.advice, .status-select.advice { border-color: #d946ef; background: #fdf4ff; color: #a21caf; }
        .active-status, .status-pill.active, .status-select.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }

        .card-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #0f172a; }
        .card-meta { font-size: 13px; color: #64748b; font-weight: 400; }

        #adminMap, #premisesMap { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* DETAIL PANEL - SOFTENED TYPOGRAPHY */
        .detail-panel { position: absolute; top: 24px; left: 24px; bottom: 24px; width: 480px; background: white; border-radius: 16px; box-shadow: 0 25px 60px rgba(0,0,0,0.3); z-index: 50; display: none; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .detail-panel.active { display: flex; }
        .detail-image { width: 100%; height: 320px; background: #1e293b; position: relative; overflow: hidden; } 
        .detail-image img { width: 100%; height: 100%; object-fit: cover; opacity: 0.95; transition: opacity 0.3s; }
        .video-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.3); cursor: pointer; z-index: 10; transition: 0.2s; }
        .video-overlay:hover { transform: translate(-50%, -50%) scale(1.1); background: white; }
        .close-detail { position: absolute; top: 16px; left: 16px; width: 36px; height: 36px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: #0f172a; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .close-detail:hover { transform: scale(1.1); }
        .gallery-nav { position: absolute; top: 0; bottom: 0; width: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; opacity: 0; transition: 0.2s; background: rgba(0,0,0,0.2); color: white; font-size: 28px; font-weight: 600; }
        .detail-image:hover .gallery-nav { opacity: 1; }
        .gallery-nav:hover { background: rgba(0,0,0,0.5); }
        .gallery-counter { position: absolute; bottom: 16px; right: 16px; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 500; z-index: 5; letter-spacing: 0.5px; }

        .detail-content { padding: 28px; overflow-y: auto; flex: 1; }
        .detail-title { font-size: 22px; font-weight: 600; color: #0f172a; margin-bottom: 6px; letter-spacing: -0.3px; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 24px 0; }
        .data-label { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .data-value { font-size: 14px; font-weight: 500; color: #1e293b; }
        
        .reports-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .reports-table th { text-align: left; font-size: 11px; color: #64748b; padding: 12px 6px; border-bottom: 2px solid #e2e8f0; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .reports-table td { font-size: 13px; padding: 14px 6px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        .icon-btn { color: #00264b; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; background: #f8fafc; border: 1px solid #e2e8f0; }
        .icon-btn:hover { background: #00264b; color: white; border-color: #00264b; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,38,75,0.2); }
        .icon-btn svg { width: 16px; height: 16px; }
        
        .back-btn { font-size: 11px; color: #0284c7; font-weight: 600; cursor: pointer; float: right; padding: 10px; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; }
        .back-btn:hover { color: #0369a1; }
        
        .marker-selected { width: 56px; height: 56px; background: white; border: 3px solid white; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; z-index: 2; position: relative; }
        .marker-selected:hover { transform: scale(1.15); z-index: 100; box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
        .marker-selected img { width: 100%; height: 100%; object-fit: cover; }
        .marker-dot { width: 24px; height: 24px; background: #00264b; border: 3px solid white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; z-index: 1; }
        .marker-dot:hover { transform: scale(1.3); z-index: 100; background: #0284c7; }
        
        /* FLOATING BUTTON (CENTERED BOTTOM) */
        #requestReportBtn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; }
        .btn-float { background: #00264b; border: 2px solid rgba(255,255,255,0.2); padding: 14px 32px; border-radius: 30px; font-weight: 600; font-size: 14px; color: white; box-shadow: 0 12px 35px rgba(0,38,75,0.4); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); letter-spacing: 0.5px; }
        .btn-float:hover { transform: translateY(-4px); box-shadow: 0 20px 45px rgba(0,38,75,0.5); background: #001d3a; }

        /* NATIVE MAPBOX CONTROLS */
        .mapboxgl-ctrl-group { background: transparent !important; box-shadow: none !important; border: none !important; margin-right: 24px !important; margin-bottom: 30px !important; display: flex !important; flex-direction: column !important; gap: 12px !important; }
        .mapboxgl-ctrl-group > button.mapboxgl-ctrl-compass { background: white !important; width: 40px !important; height: 40px !important; border-radius: 10px !important; box-shadow: 0 6px 16px rgba(0,0,0,0.12) !important; border: 1px solid rgba(255,255,255,0.8) !important; transition: 0.2s !important; }
        .mapboxgl-ctrl-group > button.mapboxgl-ctrl-compass:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important; }
        .mapboxgl-ctrl-compass .mapboxgl-ctrl-icon { filter: invert(13%) sepia(50%) saturate(5000%) hue-rotate(200deg) brightness(80%) contrast(120%) !important; }
        .mapboxgl-ctrl-group button.icon-ctrl-btn { background: white !important; width: 40px !important; height: 40px !important; padding: 0 !important; border-radius: 10px !important; box-shadow: 0 6px 16px rgba(0,0,0,0.12) !important; border: 1px solid rgba(255,255,255,0.8) !important; transition: 0.2s !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; position: relative !important; }
        .mapboxgl-ctrl-group button.icon-ctrl-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important; }
        .auto-fix-status { position: absolute; right: 55px; top: 50%; transform: translateY(-50%); background: white; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; color: #00264b; box-shadow: 0 6px 20px rgba(0,0,0,0.15); white-space: nowrap; pointer-events: none; border: 1px solid #e2e8f0; }
        
        /* MODAL FOR REQUEST REPORT */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { background: white; width: 550px; max-width: 90%; border-radius: 16px; box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden; transform: translateY(20px) scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.5); }
        .modal-overlay.active .modal-card { transform: translateY(0) scale(1); }
        .modal-header { background: #00264b; color: white; padding: 24px 28px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
        .modal-close { cursor: pointer; color: white; font-size: 24px; opacity: 0.7; transition: 0.2s; background: none; border: none; }
        .modal-close:hover { opacity: 1; transform: scale(1.1); }
        .modal-body { padding: 28px; max-height: 70vh; overflow-y: auto; }
        .form-row { display: flex; gap: 16px; margin-bottom: 16px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        .file-upload-box { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; background: #f8fafc; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 100px; }
        .file-upload-box:hover { border-color: #00264b; background: #f1f5f9; box-shadow: inset 0 0 0 1px rgba(0,38,75,0.05); }
        .file-upload-box input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-label-text { font-size: 13px; font-weight: 600; color: #475569; }
        .file-name-display { font-size: 11px; color: #0284c7; margin-top: 8px; font-weight: 500; word-break: break-all; }
        .modal-footer { padding: 20px 28px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-cancel { padding: 12px 24px; background: white; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; color: #475569; cursor: pointer; transition: 0.2s; }
        .btn-cancel:hover { background: #f1f5f9; color: #0f172a; border-color: #94a3b8; }
    </style>
</head>
<body>

    <div id="debugConsole"></div>

    <div id="requestReportBtn">
        <button class="btn-float" onclick="openRequestModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Request a Report
        </button>
    </div>

    <div id="requestModalOverlay" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>New Report Request</h2>
                <button class="modal-close" onclick="closeRequestModal()">‚úï</button>
            </div>
            <form id="requestReportForm">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Property Manager Name</label>
                            <input type="text" id="reqManagerName" class="form-input" required placeholder="Full Name">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Delivery Deadline</label>
                            <input type="date" id="reqDeadline" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Premise Address</label>
                        <input type="text" id="reqAddress" class="form-input" required placeholder="Full property address">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Report Type</label>
                        <select id="reqType" class="form-input" required style="cursor:pointer;">
                            <option value="" disabled selected>Select required report type...</option>
                            <option value="BCA">BCA (Building Condition Assessment)</option>
                            <option value="COO">COO (Change of Operator/Owner)</option>
                            <option value="FMP">FMP (Forward Maintenance Plan)</option>
                            <option value="MGA">MGA (Make Good Assessment)</option>
                            <option value="PCR">PCR (Property Condition Report)</option>
                            <option value="RCA">RCA (Reinstatement Cost Assessment)</option>
                            <option value="RMP">RMP (Roof Maintenance Plan)</option>
                            <option value="TDD">TDD (Technical Due Diligence)</option>
                            <option value="Capex">CapEx (Capital Expenditure)</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <label class="form-label" style="margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Attachments (Optional)</label>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="file-upload-box">
                                    <input type="file" id="reqLeaseFile" multiple accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName(this, 'leaseFileName')">
                                    <div class="file-label-text">üìÑ Upload Leases</div>
                                    <div id="leaseFileName" class="file-name-display"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="file-upload-box">
                                    <input type="file" id="reqPlanFile" multiple accept=".pdf, .jpg, .jpeg, .png" onchange="updateFileName(this, 'planFileName')">
                                    <div class="file-label-text">üìê Upload Plans</div>
                                    <div id="planFileName" class="file-name-display"></div>
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #94a3b8; text-align: center; margin-top: -5px; font-weight: 500;">You can select multiple files at once.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeRequestModal()">Cancel</button>
                    <button type="submit" class="btn-access" id="submitRequestBtn" style="width: auto; padding: 12px 32px;">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loginScreen" class="screen active">
        <div id="loginMapBackground"></div>
        <div class="login-card">
            <div class="login-header"><h1>BAYLEYS</h1><p>Property Survey System</p></div>
            <form id="loginForm">
                <div class="form-group"><label class="form-label">User ID</label><input type="text" class="form-input" id="userId" placeholder="Centuria" required></div>
                <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="userPassword" placeholder="cent123" required></div>
                <button type="submit" class="btn-access" id="loginBtn">Login</button>
            </form>
        </div>
    </div>

    <div id="clientListScreen" class="screen">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1 style="margin-top: 15px;">BAYLEYS</h1>
                <p>Admin Console</p>
            </div>
            <div class="user-profile">
                <div style="display:flex; gap:10px; align-items:center;"><div class="avatar">BA</div><div><div style="font-size:13px; font-weight:600; color:#0f172a;">Bayleys Admin</div><div style="font-size:10px; color:#64748b; font-weight:500;">ADMINISTRATOR</div></div></div>
                <div class="logout-link" onclick="window.location.reload()">LOGOUT</div>
            </div>
            <div class="sidebar-search-container">
                <div class="search-input-wrapper">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="adminSearchInput" placeholder="Search database...">
                    <button class="clear-btn" id="adminClearSearch" style="display:none;">‚úï</button>
                </div>
            </div>
            <div class="filter-bar">
                <div class="filter-btn active" onclick="filterAdminView('clients')">Clients</div>
                <div class="filter-btn" onclick="filterAdminView('reports')">Reports</div>
            </div>
            <div class="sidebar-scroll" id="clientList">Loading...</div>
        </div>
        <div class="main-content">
            <div id="adminMap"></div>
            
            <div class="admin-dashboard-widgets" id="adminDashboardWidgets" style="display:none;">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="statActive">-</div><div class="stat-label">Active Jobs</div></div>
                    <div class="stat-card"><div class="stat-value" id="statInspect">-</div><div class="stat-label">To Inspect</div></div>
                    <div class="stat-card"><div class="stat-value" id="statInvoice">-</div><div class="stat-label">To Invoice</div></div>
                    <div class="stat-card"><div class="stat-value" id="statPremises">-</div><div class="stat-label">Total Premises</div></div>
                </div>
                <div class="chart-container">
                    <div class="chart-box">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="premisesScreen" class="screen">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo-container"><img id="brandLogo" src="" alt="Client Logo"></div>
                <p>PORTFOLIO ACCESS</p>
            </div>
            <div class="user-profile">
                <div style="display:flex; gap:10px; align-items:center;">
                    <div class="avatar" id="userAvatar">U</div>
                    <div><div style="font-size:13px; font-weight:600; color:#0f172a;" id="userNameDisplay">Client Name</div><div style="font-size:10px; color:#64748b; font-weight:500;">CLIENT VIEW</div></div>
                </div>
                <div class="logout-link" onclick="window.location.reload()">LOGOUT</div>
            </div>
            <div class="sidebar-search-container">
                <div class="search-input-wrapper">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="clientSearchInput" placeholder="Search premises...">
                    <button class="clear-btn" id="clientClearSearch" style="display:none;">‚úï</button>
                </div>
            </div>
            <div class="back-btn" id="backToAdminBtn" style="display:none;">‚Üê BACK TO ADMIN</div>
            <div class="sidebar-scroll" id="premisesList">Loading...</div>
        </div>
        <div class="main-content">
            <div id="premisesMap"></div>
            
            <div id="propertyDetailPanel" class="detail-panel">
                <div class="detail-image">
                    <img id="detailImg" src="">
                    <div class="gallery-nav gallery-prev" id="prevImgBtn">‚Äπ</div>
                    <div class="gallery-nav gallery-next" id="nextImgBtn">‚Ä∫</div>
                    <div class="gallery-counter" id="imgCounter">1 / 1</div>
                    <div class="video-overlay" id="videoBtn"><div class="play-button"><svg width="24" height="24" viewBox="0 0 24 24" fill="#00264b"><path d="M8 5v14l11-7z"/></svg></div></div>
                    <div class="close-detail" id="closeDetailBtn">‚úï</div>
                </div>
                <div class="detail-content">
                    <h2 class="detail-title" id="detailTitle">Property Name</h2>
                    <div style="font-size:14px; color:#64748b; margin-bottom:20px; font-weight:400;" id="detailAddress">Address</div>
                    <div class="detail-grid">
                        <div><div class="data-label">Floor Area</div><div class="data-value" id="detailFloor">-</div></div>
                        <div><div class="data-label">Site Area</div><div class="data-value" id="detailSite">-</div></div>
                        <div><div class="data-label">Sector</div><div class="data-value" id="detailSector">-</div></div>
                        <div><div class="data-label">Age</div><div class="data-value" id="detailAge">-</div></div>
                        <div><div class="data-label">Condition</div><div class="data-value" id="detailCond">-</div></div>
                        <div><div class="data-label">Surveyed By</div><div class="data-value" id="detailSurveyor">-</div></div>
                        <div><div class="data-label">Last Inspected</div><div class="data-value" id="detailInspected">-</div></div>
                        <div><div class="data-label">Delivered</div><div class="data-value" id="detailDelivery">-</div></div>
                    </div>
                    <div style="font-size:12px; font-weight:600; color:#475569; margin-top:30px; border-bottom:2px solid #f1f5f9; padding-bottom:12px; letter-spacing:1px;">REPORTS & DOCUMENTS</div>
                    <table class="reports-table">
                        <thead><tr><th>Property</th><th>Type</th><th>Job #</th><th>Status</th><th>PDF</th><th>INFO</th><th>INV</th></tr></thead>
                        <tbody id="reportsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const SUPABASE_URL = 'https://qppsjxvkoihirzicllvg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwcHNqeHZrb2loaXJ6aWNsbHZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTg1OTEsImV4cCI6MjA4NjQ5NDU5MX0.aG7O5llSU-VdovwInmDZabvTtOQNPs2aay5cIU1How0';
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiZ2hpei1jIiwiYSI6ImNtbHpsczQwMTA4bGszZnEyOWk3ejdsdzQifQ.Uyr2i4jlcL04Rf8aaEzv-A';
        
        const CUSTOM_STYLE = 'mapbox://styles/ghiz-c/cmlzw6qpb003601rje5a8elgh';
        const SATELLITE_STYLE = 'mapbox://styles/mapbox/satellite-streets-v12';
        let currentMapStyle = CUSTOM_STYLE;

        const STATUS_OPTIONS = ['New', 'Inspection', 'Report', 'Advice', 'Invoice', 'Pending', 'Complete'];

        // --- SMART CONSOLE HIDE ---
        const logBox = document.getElementById('debugConsole');
        let logTimeout;
        function log(msg, isError = false) { 
            console.log(msg); 
            logBox.innerText = msg; 
            logBox.className = isError ? 'error' : '';
            logBox.style.opacity = '1';
            logBox.style.transform = 'translateY(0)';
            
            clearTimeout(logTimeout);
            
            if (!isError) {
                logTimeout = setTimeout(() => { 
                    logBox.style.opacity = '0'; 
                    logBox.style.transform = 'translateY(10px)'; 
                }, 2500);
            }
        }

        let supabase, mapInstance, clientsData = [], premisesData = [], allReportsData = [], currentUser = null;
        let currentGalleryImages = [];
        let currentGalleryIndex = 0;
        let growthChart = null; 
        let currentViewedPremise = null;
        let activeAdminTab = 'clients';

        const normalizeStatus = (status) => (status || '').toString().toLowerCase().trim();

        // --- REQUEST REPORT MODAL LOGIC ---
        window.openRequestModal = () => {
            document.getElementById('requestModalOverlay').classList.add('active');
        };

        window.closeRequestModal = () => {
            document.getElementById('requestModalOverlay').classList.remove('active');
            document.getElementById('requestReportForm').reset();
            document.getElementById('leaseFileName').innerText = '';
            document.getElementById('planFileName').innerText = '';
        };

        window.updateFileName = (input, displayId) => {
            const displayEl = document.getElementById(displayId);
            if (input.files.length === 0) displayEl.innerText = '';
            else if (input.files.length === 1) displayEl.innerText = input.files[0].name;
            else displayEl.innerText = `${input.files.length} files selected`;
        };

        async function uploadMultipleFiles(fileInput, folderName) {
            if (!fileInput.files || fileInput.files.length === 0) return null;
            const uploadedUrls = [];
            for (const file of fileInput.files) {
                const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
                const filePath = `${folderName}/${Date.now()}_${safeName}`;
                
                const { error } = await supabase.storage.from('report_requests').upload(filePath, file);
                if (error) throw new Error(`Failed to upload ${file.name}: ${error.message}`);
                
                const { data } = supabase.storage.from('report_requests').getPublicUrl(filePath);
                uploadedUrls.push(data.publicUrl);
            }
            return uploadedUrls;
        }

        document.getElementById('requestReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitRequestBtn');
            const originalText = btn.innerText;
            btn.innerText = 'Uploading...';
            btn.disabled = true;

            try {
                log("Packaging request and uploading files...");

                const leaseUrls = await uploadMultipleFiles(document.getElementById('reqLeaseFile'), 'leases');
                const planUrls = await uploadMultipleFiles(document.getElementById('reqPlanFile'), 'plans');

                const formData = {
                    client_name: currentUser ? currentUser.name : 'Unknown Client',
                    property_manager: document.getElementById('reqManagerName').value,
                    address: document.getElementById('reqAddress').value,
                    report_type: document.getElementById('reqType').value,
                    delivery_deadline: document.getElementById('reqDeadline').value,
                    status: 'Pending',
                    request_date: new Date().toISOString()
                };

                if (leaseUrls) formData.lease_url = leaseUrls; 
                if (planUrls) formData.plan_url = planUrls;

                btn.innerText = 'Saving...';
                
                const { error: insertError } = await supabase.from('report_requests').insert([formData]);
                if (insertError) throw insertError;

                log("Report request sent successfully!");
                alert("Success! Your report request has been sent to David.");
                closeRequestModal();

            } catch (err) {
                log("Error: " + err.message, true);
                alert("Failed to submit request:\n" + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- NATIVE SEARCH EVENT LISTENERS ---
        document.getElementById('adminSearchInput').addEventListener('input', (e) => {
            document.getElementById('adminClearSearch').style.display = e.target.value.length > 0 ? 'flex' : 'none';
            window.filterAdminView(activeAdminTab);
        });

        document.getElementById('adminClearSearch').addEventListener('click', () => {
            const input = document.getElementById('adminSearchInput');
            input.value = '';
            document.getElementById('adminClearSearch').style.display = 'none';
            window.filterAdminView(activeAdminTab);
            input.focus();
        });

        document.getElementById('clientSearchInput').addEventListener('input', (e) => {
            document.getElementById('clientClearSearch').style.display = e.target.value.length > 0 ? 'flex' : 'none';
            loadClientView();
        });

        document.getElementById('clientClearSearch').addEventListener('click', () => {
            const input = document.getElementById('clientSearchInput');
            input.value = '';
            document.getElementById('clientClearSearch').style.display = 'none';
            loadClientView();
            input.focus();
        });

        // Mapbox Style Switcher
        class StyleToggleControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
                
                this._btn = document.createElement('button');
                this._btn.className = 'icon-ctrl-btn';
                this._btn.type = 'button';
                this._btn.title = "Toggle Satellite/3D View";
                
                const icon3D = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00264b" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>`;
                const iconSat = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00264b" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`;
                
                this._btn.innerHTML = iconSat;
                
                this._btn.onclick = () => {
                    if (currentMapStyle === CUSTOM_STYLE) {
                        currentMapStyle = SATELLITE_STYLE;
                        this._btn.innerHTML = icon3D;
                    } else {
                        currentMapStyle = CUSTOM_STYLE;
                        this._btn.innerHTML = iconSat;
                    }
                    this._map.setStyle(currentMapStyle, { diff: false });
                };
                
                this._container.appendChild(this._btn);
                return this._container;
            }
            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        // Admin Tools Control (Includes Auto-Fix Coordinates AND Image Sync)
        class AdminToolsControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
                this._container.style.position = 'relative';
                
                if (!currentUser || currentUser.role !== 'admin') {
                    this._container.style.display = 'none';
                }
                
                // Button 1: Sync Images
                this._btnSync = document.createElement('button');
                this._btnSync.className = 'icon-ctrl-btn';
                this._btnSync.type = 'button';
                this._btnSync.title = "Sync Report Cover Images";
                const imgIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00264b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`;
                this._btnSync.innerHTML = imgIcon;
                
                // Button 2: Auto-Find Coordinates
                this._btnFix = document.createElement('button');
                this._btnFix.className = 'icon-ctrl-btn';
                this._btnFix.type = 'button';
                this._btnFix.title = "Auto-Find Missing Coordinates";
                const crosshairIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00264b" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>`;
                this._btnFix.innerHTML = crosshairIcon;
                
                const loadingIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00264b" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
                
                this._status = document.createElement('div');
                this._status.className = 'auto-fix-status';
                this._status.style.display = 'none';
                
                this._container.appendChild(this._btnSync);
                this._container.appendChild(this._btnFix);
                this._container.appendChild(this._status);
                
                // ----------------------------------------------------
                // LOGIC: Sync Report Cover Images
                // ----------------------------------------------------
                this._btnSync.onclick = async () => {
                    if (!currentUser || currentUser.role !== 'admin') return;
                    try {
                        this._btnSync.disabled = true;
                        this._btnFix.disabled = true;
                        this._btnSync.innerHTML = loadingIcon;
                        this._status.style.display = 'block';
                        this._status.innerText = "Scanning Storage...";
                        
                        // Fetch all files from the 'GEOMAP-JOB Covers' bucket
                        const { data: files, error: storageError } = await supabase.storage.from('GEOMAP-JOB Covers').list('', { limit: 3000 });
                        if (storageError) throw storageError;

                        this._status.innerText = `Found ${files.length} images. Processing...`;
                        
                        // Group files by job_number
                        const jobImages = {};
                        for (const file of files) {
                            if (file.name === '.emptyFolderPlaceholder') continue;
                            
                            // Extract job number from start of filename (e.g. "2105 - Cover.JPG" -> "2105")
                            const match = file.name.match(/^(\d+)/);
                            if (match) {
                                const jobNo = match[1];
                                const { data: pubUrlData } = supabase.storage.from('GEOMAP-JOB Covers').getPublicUrl(file.name);
                                
                                if (!jobImages[jobNo]) jobImages[jobNo] = [];
                                jobImages[jobNo].push(pubUrlData.publicUrl);
                            }
                        }

                        this._status.innerText = `Updating Database...`;
                        
                        let updatedCount = 0;
                        for (const [jobNo, urls] of Object.entries(jobImages)) {
                            // Update reports where job_number matches, saving URLs as a JSON array
                            const { error: updateErr } = await supabase.from('reports').update({ image_url: urls }).eq('job_number', jobNo);
                            if (!updateErr) updatedCount++;
                        }
                        
                        this._status.innerText = `Success! Synced images for ${updatedCount} reports.`;
                        await fetchAdminData(); 
                        setTimeout(() => { this._reset(imgIcon, crosshairIcon); }, 3500);
                        
                    } catch (err) { 
                        log("Sync Tool Error: " + err.message, true); 
                        this._status.innerText = "Error: " + err.message; 
                        setTimeout(() => { this._reset(imgIcon, crosshairIcon); }, 3500);
                    }
                };

                // ----------------------------------------------------
                // LOGIC: Auto-Find Missing Coordinates
                // ----------------------------------------------------
                this._btnFix.onclick = async () => {
                    if (!currentUser || currentUser.role !== 'admin') return;
                    try {
                        this._btnFix.disabled = true;
                        this._btnSync.disabled = true;
                        this._btnFix.innerHTML = loadingIcon;
                        this._status.style.display = 'block';
                        this._status.innerText = "Scanning Database...";
                        
                        const { data: missingList } = await supabase.from('premises').select('*').is('lat', null);
                        
                        if (!missingList || missingList.length === 0) { 
                            this._status.innerText = "All Coordinates Found!"; 
                            setTimeout(() => { this._reset(imgIcon, crosshairIcon); }, 2000); 
                            return; 
                        }
                        
                        this._status.innerText = `Fixing ${missingList.length} items...`;
                        let fixedCount = 0;
                        for (const p of missingList) {
                            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(p.address)}.json?access_token=${MAPBOX_TOKEN}&country=nz&limit=1`;
                            const res = await fetch(url);
                            const json = await res.json();
                            if (json.features && json.features.length > 0) {
                                const [lng, lat] = json.features[0].center;
                                await supabase.from('premises').update({ lat, lng }).eq('id', p.id);
                                fixedCount++;
                                this._status.innerText = `Fixed ${fixedCount}/${missingList.length}`;
                            }
                            await new Promise(r => setTimeout(r, 200));
                        }
                        
                        this._status.innerText = `Update Complete!`;
                        await fetchAdminData();
                        setTimeout(() => { this._reset(imgIcon, crosshairIcon); }, 3000);
                        
                    } catch (err) { 
                        log("Fix Tool Error: " + err.message, true); 
                        this._status.innerText = "Error: " + err.message; 
                        setTimeout(() => { this._reset(imgIcon, crosshairIcon); }, 3000);
                    }
                };

                return this._container;
            }
            
            _reset(imgIcon, crosshairIcon) {
                this._btnFix.disabled = false;
                this._btnSync.disabled = false;
                this._status.style.display = 'none';
                this._btnSync.innerHTML = imgIcon;
                this._btnFix.innerHTML = crosshairIcon;
            }
            
            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        function renderGrowthChart(premises, reports) {
            const ctx = document.getElementById('growthChart');
            if (!ctx) return;

            const months = [];
            const premiseCounts = [];
            const reportCounts = [];

            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthStr = d.toLocaleString('default', { month: 'short', year: '2-digit' });
                months.push(monthStr);

                const pCount = premises.filter(p => {
                    if (!p.created_at) return false;
                    const pd = new Date(p.created_at);
                    return pd.getMonth() === d.getMonth() && pd.getFullYear() === d.getFullYear();
                }).length;
                premiseCounts.push(pCount);

                const rCount = reports.filter(r => {
                    const targetDateStr = r.delivery_date || r.inspection_date || r.created_at;
                    if (!targetDateStr) return false;
                    const rd = new Date(targetDateStr);
                    if (isNaN(rd)) return false;
                    return rd.getMonth() === d.getMonth() && rd.getFullYear() === d.getFullYear();
                }).length;
                reportCounts.push(rCount);
            }

            if (window.growthChart instanceof Chart) {
                window.growthChart.destroy();
            }

            const canvasContext = ctx.getContext('2d');
            const gradientBlue = canvasContext.createLinearGradient(0, 0, 0, 200);
            gradientBlue.addColorStop(0, 'rgba(49, 130, 206, 0.5)');
            gradientBlue.addColorStop(1, 'rgba(49, 130, 206, 0.0)');

            const gradientGreen = canvasContext.createLinearGradient(0, 0, 0, 200);
            gradientGreen.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
            gradientGreen.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            window.growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        { 
                            label: 'New Reports', 
                            data: reportCounts, 
                            borderColor: '#3182ce', 
                            backgroundColor: gradientBlue, 
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4, 
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#3182ce',
                            pointBorderWidth: 2
                        },
                        { 
                            label: 'New Premises', 
                            data: premiseCounts, 
                            borderColor: '#10b981', 
                            backgroundColor: gradientGreen, 
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4, 
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#10b981',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top', labels: { boxWidth: 10, font: { size: 11, family: 'sans-serif', weight: '500' }, color: '#475569', usePointStyle: true } },
                        tooltip: { backgroundColor: 'rgba(15,23,42,0.95)', titleFont: {size: 13, weight:'bold'}, bodyFont: {size: 12}, padding: 12, cornerRadius: 8, boxPadding: 6 }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 }, color: '#94a3b8' }, border: {display: false} },
                        y: { beginAtZero: true, grid: { color: 'rgba(226, 232, 240, 0.6)', borderDash: [5, 5] }, border: { display: false }, ticks: { font: { size: 10 }, color: '#94a3b8', stepSize: 1, precision: 0 } }
                    }
                }
            });
        }

        window.updateReportStatus = async (reportId, newStatus, selectElement) => {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const safeClass = normalizeStatus(newStatus);
            selectElement.className = `status-select ${safeClass}-status`;
            selectElement.blur();
            
            try {
                const { error } = await supabase.from('reports').update({ status: newStatus }).eq('id', reportId);
                if (error) throw error;
                log(`Status updated to ${newStatus}`);
                
                const { data: r } = await supabase.from('reports').select('*');
                if (r) {
                    allReportsData = r;
                    
                    if (currentUser.role === 'admin') {
                        await fetchAdminData();
                        const activeTabBtn = document.querySelector('.filter-btn.active');
                        if (activeTabBtn) window.filterAdminView(activeTabBtn.innerText.toLowerCase());
                        
                        if (currentViewedPremise) {
                            const updatedPremise = premisesData.find(x => x.id === currentViewedPremise.id);
                            if (updatedPremise) showDetail(updatedPremise);
                        }
                    }
                }
            } catch (err) { log("Update failed: " + err.message, true); alert("Update failed: " + err.message); }
        };

        function getPremiseDisplayData(p) {
            const reports = p.reports || allReportsData.filter(r => r.premise_id === p.id) || [];
            reports.sort((a, b) => (Number(b.job_number) || 0) - (Number(a.job_number) || 0));
            const latest = reports.length > 0 ? reports[0] : {};
            
            // --- AGGREGATE ALL IMAGES FROM ALL REPORTS FOR THIS PREMISE ---
            let allImages = [];
            reports.forEach(r => {
                let rawImages = r.image_url;
                if (Array.isArray(rawImages)) {
                    allImages.push(...rawImages);
                } else if (typeof rawImages === 'string' && rawImages.trim() !== '') {
                    try {
                        const parsed = JSON.parse(rawImages);
                        if (Array.isArray(parsed)) allImages.push(...parsed);
                    } catch(e) {
                        allImages.push(...(rawImages.includes(',') ? rawImages.split(',').map(s=>s.trim()) : [rawImages]));
                    }
                }
            });
            
            // Remove duplicates just in case
            let images = [...new Set(allImages)];

            const displayImage = images.length > 0 ? images[0] : null;
            const status = latest.status || 'Active';
            const condition = latest.condition || p.condition || '-';
            return { reports, latest, images, displayImage, status, condition };
        }

        function toggleDashboardOverlay(show) {
            const dash = document.getElementById('adminDashboardWidgets');
            if (dash && currentUser && currentUser.role === 'admin') {
                if (show) {
                    dash.style.display = 'flex';
                    setTimeout(() => dash.classList.remove('hidden'), 10);
                } else {
                    dash.classList.add('hidden');
                    setTimeout(() => { if (dash.classList.contains('hidden')) dash.style.display = 'none'; }, 300);
                }
            }
        }

        window.onload = async () => {
            log("System starting...");
            try {
                mapboxgl.accessToken = MAPBOX_TOKEN;
                initMap('loginMapBackground', [173.0, -41.2], 4.8, 0, 0, SATELLITE_STYLE);
                
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                const { count, error } = await supabase.from('clients').select('*', { count: 'exact', head: true });
                if (error) throw error;
                log(`System Ready.`);
            } catch(e) { log("DB Error: " + e.message, true); }
        };

        function initMap(container, center, zoom, pitch = 60, bearing = -17.6, overrideStyle = null) {
            if (mapInstance && mapInstance._container && mapInstance._container.id !== container) {
                mapInstance.remove();
                mapInstance = null;
            }
            if (mapInstance && mapInstance._container && mapInstance._container.id === container) return mapInstance;

            try {
                mapInstance = new mapboxgl.Map({
                    container: container,
                    style: overrideStyle || currentMapStyle,
                    center: center,
                    zoom: zoom,
                    pitch: pitch,
                    bearing: bearing,
                    antialias: true
                });

                if (container !== 'loginMapBackground') {
                    mapInstance.addControl(new mapboxgl.NavigationControl({ showZoom: false }), 'bottom-right');
                    mapInstance.addControl(new StyleToggleControl(), 'bottom-right');
                    // Injecting Admin Tools (Sync & Fix) here
                    mapInstance.addControl(new AdminToolsControl(), 'bottom-right');
                }
                return mapInstance;
            } catch (error) { log('Init error: ' + error.message, true); }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rawInput = document.getElementById('userId').value.trim();
            const pass = document.getElementById('userPassword').value;
            const btn = document.getElementById('loginBtn');
            btn.textContent = "Verifying...";

            try {
                const fakeEmail = `${rawInput}@bayleys.co.nz`; 
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ email: fakeEmail, password: pass });
                if (authError) throw new Error("Incorrect Username or Password");
                const userId = authData.user.id;
                const { data: clientData } = await supabase.from('clients').select('*').eq('id', userId).single();

                if (clientData) {
                    currentUser = { role: 'client', ...clientData };
                    await fetchClientPremises(currentUser.id);
                    switchScreen('premisesScreen');
                    loadClientView();
                } else {
                    currentUser = { role: 'admin', name: 'Bayleys Admin' };
                    await fetchAdminData();
                    switchScreen('clientListScreen');
                    window.filterAdminView('clients'); 
                }
            } catch (err) { log("Login Error: " + err.message, true); alert(err.message); btn.textContent = "Login"; }
        });

        async function fetchAdminData() {
            log("Fetching data...");
            const { data: c } = await supabase.from('clients').select('*');
            const { data: r } = await supabase.from('reports').select('*');
            const { data: p } = await supabase.from('premises').select('*');
            allReportsData = r || [];
            premisesData = p || [];
            
            if (currentUser && currentUser.role === 'admin') {
                toggleDashboardOverlay(true);

                const activeJobs = allReportsData.filter(job => {
                    const s = normalizeStatus(job.status);
                    return !s.includes('complete') && !s.includes('invoice') && !s.includes('pending');
                }).length;
                const toInspect = allReportsData.filter(job => normalizeStatus(job.status).includes('new')).length;
                const toInvoice = allReportsData.filter(job => {
                    const s = normalizeStatus(job.status);
                    return s.includes('report') || s.includes('advice');
                }).length;

                document.getElementById('statActive').innerText = activeJobs;
                document.getElementById('statInspect').innerText = toInspect;
                document.getElementById('statInvoice').innerText = toInvoice;
                document.getElementById('statPremises').innerText = premisesData.length;

                renderGrowthChart(premisesData, allReportsData);
                log("Data Loaded successfully!");
            }

            clientsData = (c || []).map(client => {
                const clientReports = allReportsData.filter(x => x.client_id === client.id);
                const uniquePremises = new Set(clientReports.map(rep => rep.premise_id));
                const activeCount = clientReports.filter(job => {
                    const s = normalizeStatus(job.status);
                    return !s.includes('complete') && !s.includes('invoice') && !s.includes('pending');
                }).length;
                
                return { ...client, count: uniquePremises.size, active: activeCount };
            });
            
            if (mapInstance && mapInstance.loaded()) addMarkers(premisesData);
            else if (mapInstance) mapInstance.on('load', () => addMarkers(premisesData));
        }

        async function fetchClientPremises(cid) {
            log("Fetching client portfolio...");
            const { data, error } = await supabase.from('premises').select('*, reports!inner(*)').eq('reports.client_id', cid);
            if (error) { log("Error: " + error.message, true); return; }
            premisesData = data || [];
            if (mapInstance && mapInstance.loaded()) addMarkers(premisesData);
            else if (mapInstance) mapInstance.on('load', () => addMarkers(premisesData));
            log("Portfolio ready.");
        }

        window.filterAdminView = (type) => {
            activeAdminTab = type;
            const list = document.getElementById('clientList');
            const btns = document.querySelectorAll('.filter-bar .filter-btn');
            btns.forEach(b => b.classList.remove('active'));

            const query = (document.getElementById('adminSearchInput').value || '').toLowerCase().trim();

            if (type === 'clients') {
                btns[0].classList.add('active');
                
                let filteredClients = clientsData;
                if (query) {
                    filteredClients = filteredClients.filter(c => c.name.toLowerCase().includes(query));
                }
                
                const sortedClients = [...filteredClients].sort((a, b) => a.name.localeCompare(b.name));
                
                if(sortedClients.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding: 40px 20px; color: #94a3b8; font-size: 13px; font-weight: 500;">No clients found matching "${query}"</div>`;
                    return;
                }

                list.innerHTML = sortedClients.map(c => `
                    <div class="card-item client-card" data-id="${c.id}">
                        <img src="${c.logo_url}" alt="${c.name} Logo">
                        <div class="client-card-title">${c.name}</div>
                        <div class="client-card-meta">${c.count} Premises &nbsp;‚Ä¢&nbsp; <span>${c.active} Active Jobs</span></div>
                    </div>`).join('');
                    
                document.querySelectorAll('.client-card').forEach(card => {
                    card.addEventListener('click', async () => {
                        toggleDashboardOverlay(false);
                        const client = clientsData.find(c => c.id === card.dataset.id);
                        currentUser = { role: 'admin', ...client };
                        document.getElementById('backToAdminBtn').style.display = 'block';
                        await fetchClientPremises(client.id);
                        switchScreen('premisesScreen');
                        loadClientView();
                    });
                });
            } else if (type === 'reports') {
                btns[1].classList.add('active');
                
                let filteredReports = allReportsData;
                if (query) {
                    filteredReports = filteredReports.filter(r => {
                        const matchingPremise = premisesData.find(p => p.id === r.premise_id);
                        const displayName = (r.name || (matchingPremise ? matchingPremise.name : '')).toLowerCase();
                        const address = (matchingPremise ? matchingPremise.address : '').toLowerCase();
                        return (r.job_number && String(r.job_number).toLowerCase().includes(query)) ||
                               (r.report_type && r.report_type.toLowerCase().includes(query)) ||
                               displayName.includes(query) || 
                               address.includes(query);
                    });
                }
                
                const statusOrder = { 'new': 1, 'inspection': 2, 'report': 3, 'advice': 4, 'invoice': 5, 'pending': 6, 'complete': 7 };
                
                const sortedReports = [...filteredReports].sort((a, b) => {
                    const rankA = statusOrder[normalizeStatus(a.status)] || 99;
                    const rankB = statusOrder[normalizeStatus(b.status)] || 99;
                    if (rankA !== rankB) return rankA - rankB;
                    return (Number(b.job_number) || 0) - (Number(a.job_number) || 0);
                });

                if(sortedReports.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding: 40px 20px; color: #94a3b8; font-size: 13px; font-weight: 500;">No reports found matching "${query}"</div>`;
                    return;
                }

                list.innerHTML = sortedReports.map(r => {
                    const matchingPremise = premisesData.find(p => p.id === r.premise_id);
                    const displayName = r.name || (matchingPremise ? matchingPremise.name : 'Unknown Property');
                    const safeClass = normalizeStatus(r.status);
                    
                    return `
                    <div class="card-item report-card-admin" data-pid="${r.premise_id}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:11px; font-weight:600; color:#0f172a;">${displayName}</div>
                                <div style="font-weight:600; font-size:13px; color:#0284c7; margin-top:2px;">Job #${r.job_number}</div>
                                <div style="font-size:10px; color:#64748b; font-weight:500; margin-top:1px;">${r.report_type}</div>
                            </div>
                            <div class="status-pill ${safeClass}-status" style="position:static;">${r.status}</div>
                        </div>
                    </div>`;
                }).join('');
                document.querySelectorAll('.report-card-admin').forEach(card => {
                    card.addEventListener('click', () => {
                        const p = premisesData.find(x => x.id === card.dataset.pid);
                        if (p) showDetail(p);
                    });
                });
            }
        };

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById(id).classList.add('active');
            document.getElementById('requestReportBtn').style.display = (id === 'premisesScreen') ? 'flex' : 'none';
            
            requestAnimationFrame(() => {
                setTimeout(() => {
                    const mapContainer = id === 'clientListScreen' ? 'adminMap' : 'premisesMap';
                    const container = document.getElementById(mapContainer);
                    if (container && container.offsetWidth > 0 && container.offsetHeight > 0) {
                        initMap(mapContainer, [174.7633, -36.8485], 13);
                        if (premisesData.length > 0 && mapInstance) {
                            if (mapInstance.loaded()) addMarkers(premisesData);
                            else mapInstance.on('load', () => addMarkers(premisesData));
                        }
                    }
                }, 100);
            });
        }

        function loadClientView() {
            document.getElementById('brandLogo').src = currentUser.logo_url;
            document.getElementById('userNameDisplay').innerText = currentUser.name;
            document.getElementById('userAvatar').innerText = currentUser.name.substring(0, 2).toUpperCase();
            if (currentUser.role === 'client') document.getElementById('backToAdminBtn').style.display = 'none';
            
            const query = (document.getElementById('clientSearchInput').value || '').toLowerCase().trim();
            const list = document.getElementById('premisesList');
            
            let filteredPremises = [...premisesData];
            if (query) {
                filteredPremises = filteredPremises.filter(p => {
                    return (p.name && p.name.toLowerCase().includes(query)) || 
                           (p.address && p.address.toLowerCase().includes(query)) || 
                           (p.sector && p.sector.toLowerCase().includes(query));
                });
            }

            // --- SORT PORTFOLIO BY REPORT STATUS ---
            const statusOrder = { 'new': 1, 'inspection': 2, 'report': 3, 'advice': 4, 'invoice': 5, 'pending': 6, 'complete': 7 };
            
            filteredPremises.sort((a, b) => {
                const statusA = normalizeStatus(getPremiseDisplayData(a).status);
                const statusB = normalizeStatus(getPremiseDisplayData(b).status);
                const rankA = statusOrder[statusA] || 99;
                const rankB = statusOrder[statusB] || 99;
                
                if (rankA !== rankB) return rankA - rankB;
                return (a.name || '').localeCompare(b.name || '');
            });
            
            if(filteredPremises.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding: 40px 20px; color: #94a3b8; font-size: 13px; font-weight: 500;">No premises found matching "${query}"</div>`;
                return;
            }

            list.innerHTML = filteredPremises.map(p => {
                const { displayImage, status, condition } = getPremiseDisplayData(p);
                const safeClass = normalizeStatus(status);
                return `<div class="card-item premise-card" data-id="${p.id}">
                    <div class="premise-card-image"><img src="${displayImage || 'https://via.placeholder.com/400x300?text=No+Image'}"><div class="status-pill ${safeClass}-status">${status}</div></div>
                    <div class="card-title">${p.name}</div><div class="card-meta">${p.floor_area} &nbsp;‚Ä¢&nbsp; ${p.sector} &nbsp;‚Ä¢&nbsp; ${condition}</div>
                </div>`;
            }).join('');
            document.querySelectorAll('.premise-card').forEach(card => card.onclick = () => showDetail(premisesData.find(x => x.id === card.dataset.id)));
        }

        function addMarkers(list) {
            if (!mapInstance) return;
            const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
            existingMarkers.forEach(m => m.remove());

            list.forEach(p => {
                if (p.lat && p.lng) {
                    const { displayImage } = getPremiseDisplayData(p);
                    const el = document.createElement('div');
                    if (displayImage) { el.className = 'marker-selected'; el.innerHTML = `<img src="${displayImage}" onerror="this.style.display='none';this.parentElement.className='marker-dot'">`; } 
                    else { el.className = 'marker-dot'; }
                    el.onclick = () => showDetail(p);
                    new mapboxgl.Marker(el).setLngLat([p.lng, p.lat]).addTo(mapInstance);
                }
            });
            if (list.length > 0 && list[0].lat && mapInstance) mapInstance.flyTo({ center: [list[0].lng, list[0].lat], zoom: 14 });
        }

        function showDetail(p) {
            currentViewedPremise = p; 
            toggleDashboardOverlay(false);
            
            const detailPanel = document.getElementById('propertyDetailPanel');
            const activeMainContent = document.querySelector('.screen.active .main-content');
            if (activeMainContent && detailPanel.parentNode !== activeMainContent) {
                activeMainContent.appendChild(detailPanel);
            }

            const { reports, latest, images, displayImage, status, condition } = getPremiseDisplayData(p);
            detailPanel.classList.add('active');
            currentGalleryImages = images.length > 0 ? images : ['https://via.placeholder.com/450x360?text=No+Image'];
            currentGalleryIndex = 0;
            updateGalleryImage();
            document.getElementById('detailTitle').innerText = p.name;
            document.getElementById('detailAddress').innerText = p.address;
            document.getElementById('detailFloor').innerText = p.floor_area || '-';
            document.getElementById('detailSite').innerText = p.site_area || '-';
            document.getElementById('detailSector').innerText = p.sector || '-';
            const currentYear = new Date().getFullYear();
            document.getElementById('detailAge').innerText = p.year_built ? `${currentYear - p.year_built} Years` : '-';
            document.getElementById('detailCond').innerText = condition;
            document.getElementById('detailSurveyor').innerText = latest.surveyed_by || '-';
            document.getElementById('detailInspected').innerText = latest.inspection_date || '-';
            document.getElementById('detailDelivery').innerText = latest.delivery_date || '-';
            document.getElementById('videoBtn').style.display = latest.video_url ? 'flex' : 'none';
            document.getElementById('videoBtn').onclick = () => window.open(latest.video_url, '_blank');
            const tbody = document.getElementById('reportsTableBody');
            const isAdmin = currentUser && currentUser.role === 'admin';
            tbody.innerHTML = reports.map(r => {
                const pdfIcon = r.pdf_url ? `<a href="${r.pdf_url}" target="_blank" class="icon-btn" title="View PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></a>` : '-';
                const infoIcon = r.info_url ? `<a href="${r.info_url}" target="_blank" class="icon-btn" title="Files"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></a>` : '-';
                const invIcon = r.invoice_url ? `<a href="${r.invoice_url}" target="_blank" class="icon-btn" title="Invoice"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></a>` : '-';
                
                const safeClass = normalizeStatus(r.status);
                
                const statusHtml = isAdmin
                    ? `<select onchange="updateReportStatus('${r.id}', this.value, this)" class="status-select ${safeClass}-status">
                        ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${safeClass === opt.toLowerCase() ? 'selected' : ''}>${opt}</option>`).join('')}
                       </select>`
                    : `<span class="status-pill ${safeClass}-status" style="position:static;">${r.status}</span>`;
                const propertyDisplayName = r.name || p.name;
                return `<tr>
                    <td><span style="font-weight:500; color:#0f172a; font-size:11px;">${propertyDisplayName}</span></td>
                    <td><span style="color:#0284c7; font-weight:500;">${r.report_type || '-'}</span></td>
                    <td><span style="font-family:monospace; font-weight:500; color:#475569;">${r.job_number}</span></td>
                    <td>${statusHtml}</td>
                    <td>${pdfIcon}</td>
                    <td>${infoIcon}</td>
                    <td>${invIcon}</td>
                </tr>`;
            }).join('');
            if (mapInstance && p.lat) mapInstance.flyTo({ center: [p.lng, p.lat], zoom: 16, pitch: 60 });
        }

        function updateGalleryImage() {
            document.getElementById('detailImg').src = currentGalleryImages[currentGalleryIndex];
            document.getElementById('imgCounter').innerText = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
            const showNav = currentGalleryImages.length > 1;
            document.getElementById('prevImgBtn').style.display = showNav ? 'flex' : 'none';
            document.getElementById('nextImgBtn').style.display = showNav ? 'flex' : 'none';
        }

        document.getElementById('nextImgBtn').onclick = (e) => {
            e.stopPropagation();
            currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
            updateGalleryImage();
        };

        document.getElementById('prevImgBtn').onclick = (e) => {
            e.stopPropagation();
            currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            updateGalleryImage();
        };

        document.getElementById('closeDetailBtn').onclick = () => {
            document.getElementById('propertyDetailPanel').classList.remove('active');
            currentViewedPremise = null;
            if (mapInstance) mapInstance.flyTo({ zoom: 14, pitch: 0 });
            
            if (document.getElementById('clientListScreen').classList.contains('active')) {
                toggleDashboardOverlay(true);
            }
        };

        document.getElementById('backToAdminBtn').onclick = () => {
            currentUser = { role: 'admin', name: 'Bayleys Admin' };
            fetchAdminData().then(() => {
                switchScreen('clientListScreen');
                window.filterAdminView('clients');
                const searchInput = document.getElementById('adminSearchInput');
                searchInput.value = '';
                document.getElementById('adminClearSearch').style.display = 'none';
            });
        };
    </script>
</body>
</html>